name: Build and Release (All-in-One)

on:
  # å¯¹åº”åŸæ¥çš„ push.yaml: ä»£ç æ¨é€æ—¶è§¦å‘
  push:
    branches:
      - master
      - main
      - 'release/**'
    tags:
      - '*'
  # å¯¹åº”åŸæ¥çš„ pr-pull.yaml: ä¹Ÿå°±æ˜¯æœ‰äººæ PR æ—¶è§¦å‘
  pull_request:
    branches:
      - master
      - main
  # å¯¹åº”åŸæ¥çš„ dispatch.yaml: å…è®¸ä½ åœ¨ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹æŒ‰é’®è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥é…ç½® (å¯¹åº” build-project.yaml ä¸­çš„ check-event)
  # è¿™ä¸€æ­¥è´Ÿè´£è¯»å–ä½ çš„ buildspec.json è·å–æ’ä»¶åå­—å’Œç‰ˆæœ¬
  prepare-config:
    name: Prepare Configuration âš™ï¸
    runs-on: ubuntu-24.04
    outputs:
      pluginName: ${{ steps.setup.outputs.pluginName }}
      pluginVersion: ${{ steps.setup.outputs.pluginVersion }}
      config: ${{ steps.setup.outputs.config }}
      package: ${{ steps.setup.outputs.package }}
      codesign: ${{ steps.setup.outputs.codesign }}
      commitHash: ${{ steps.setup.outputs.commitHash }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Configuration
        id: setup
        shell: bash
        run: |
          # é»˜è®¤é…ç½®
          echo "config=RelWithDebInfo" >> $GITHUB_OUTPUT
          echo "package=true" >> $GITHUB_OUTPUT
          echo "codesign=true" >> $GITHUB_OUTPUT
          echo "commitHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT

          # è¯»å– buildspec.json çš„åå­—å’Œç‰ˆæœ¬
          if [ -f "buildspec.json" ]; then
            plugin_name=$(jq -r '.name' buildspec.json)
            plugin_version=$(jq -r '.version' buildspec.json)
            echo "pluginName=${plugin_name}" >> $GITHUB_OUTPUT
            echo "pluginVersion=${plugin_version}" >> $GITHUB_OUTPUT
          else
            echo "::error::æ‰¾ä¸åˆ° buildspec.json æ–‡ä»¶ï¼"
            exit 1
          fi

  # ç¬¬äºŒæ­¥ï¼šæ„å»º Windows ç‰ˆæœ¬ (å¯¹åº” build-project.yaml ä¸­çš„ windows-build)
  build-windows:
    name: Build Windows ğŸªŸ
    needs: prepare-config
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # è¿™é‡Œçš„ Action å¿…é¡»å­˜åœ¨äºä½ çš„ .github/actions æ–‡ä»¶å¤¹ä¸­
      - name: Build Plugin ğŸ§±
        uses: ./.github/actions/build-plugin
        with:
          target: x64
          config: ${{ needs.prepare-config.outputs.config }}

      - name: Package Plugin ğŸ“€
        uses: ./.github/actions/package-plugin
        with:
          target: x64
          config: ${{ needs.prepare-config.outputs.config }}
          package: ${{ needs.prepare-config.outputs.package }}

      - name: Upload Artifacts ğŸ“¡
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare-config.outputs.pluginName }}-${{ needs.prepare-config.outputs.pluginVersion }}-windows-x64-${{ needs.prepare-config.outputs.commitHash }}
          path: ${{ github.workspace }}/release/*windows-x64*.*

  # ç¬¬ä¸‰æ­¥ï¼šæ„å»º macOS ç‰ˆæœ¬
  build-macos:
    name: Build macOS ğŸ
    needs: prepare-config
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # è¿™é‡Œçš„ Action å¿…é¡»å­˜åœ¨äºä½ çš„ .github/actions æ–‡ä»¶å¤¹ä¸­
      - name: Build Plugin ğŸ§±
        uses: ./.github/actions/build-plugin
        with:
          target: macos-universal
          config: ${{ needs.prepare-config.outputs.config }}

      - name: Package Plugin ğŸ“€
        uses: ./.github/actions/package-plugin
        with:
          target: macos-universal
          config: ${{ needs.prepare-config.outputs.config }}
          package: ${{ needs.prepare-config.outputs.package }}

      - name: Upload Artifacts ğŸ“¡
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.prepare-config.outputs.pluginName }}-${{ needs.prepare-config.outputs.pluginVersion }}-macos-universal-${{ needs.prepare-config.outputs.commitHash }}
          path: ${{ github.workspace }}/release/*macos-universal*.*

  # ç¬¬å››æ­¥ï¼šè‡ªåŠ¨å‘å¸ƒ (å¯¹åº” push.yaml ä¸­çš„ create-release)
  # åªæœ‰å½“ä½ æ‰“ Tag (æ¯”å¦‚ v1.0.0) çš„æ—¶å€™æ‰ä¼šè¿è¡Œ
  create-release:
    name: Create Release ğŸš€
    needs: [prepare-config, build-windows, build-macos]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir release_files
          # æŠŠä¸‹è½½çš„æ‰€æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°ä¸€ä¸ªç›®å½•ï¼Œæ–¹ä¾¿æ‰“åŒ…
          find artifacts -type f -exec mv {} release_files/ \;

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
          draft: true